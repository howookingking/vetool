// TxchartEditUser.tsx
'use client'

import React, {
  type Dispatch,
  type SetStateAction,
  useEffect,
  useRef,
} from 'react'
import { useState } from 'react'
import { useForm } from 'react-hook-form'
import { nullable, object, z } from 'zod'
import { zodResolver } from '@hookform/resolvers/zod'
import { Input } from '@/components/ui/input'
import { Button } from '@/components/ui/button'
import {
  Form,
  FormControl,
  FormField,
  FormItem,
  FormLabel,
  FormMessage,
} from '@/components/ui/form'
import {
  Accordion,
  AccordionContent,
  AccordionItem,
  AccordionTrigger,
} from '@/components/ui/accordion'
import { ToggleGroup, ToggleGroupItem } from '@/components/ui/toggle-group'
import type {
  ChecklistProtocol,
  ChecklistProtocolItem,
  ChecklistSidebarData,
  TxchartData,
} from '@/types/checklist/checklistchart'
import { Textarea } from '@/components/ui/textarea'
import {
  Table,
  TableBody,
  TableCaption,
  TableCell,
  TableHead,
  TableHeader,
  TableRow,
} from '@/components/ui/table'
import {
  Select,
  SelectContent,
  SelectItem,
  SelectTrigger,
  SelectValue,
} from '@/components/ui/select'
import {
  Popover,
  PopoverContent,
  PopoverTrigger,
} from '@/components/ui/popover'
import { registerTxChart } from '@/lib/services/checklist/chart/regist-txchart'
import { toast } from '@/components/ui/use-toast'
import { createClient } from '@/lib/supabase/client'
import { redirect } from 'next/navigation'
import {
  ChecklistStateSet,
  CheckNameArray,
  ProtocolItem,
} from '@/types/checklist/checklistchart'
import { checkListSetArray } from '@/constants/checklist/checklist'

type Props = {
  txData?: ChecklistSidebarData | null
  setaChecklistEditDialogOpen: Dispatch<SetStateAction<boolean>>
}

const TxFormSchema = z.object({
  checklistTitle: z.string().min(1, 'Ï∞®Ìä∏ Ï†úÎ™©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî'),
  checklistVet: z
    .object({
      attending: z.string().nullable(),
      primary: z.string().nullable(),
      assistence: z.string().nullable(),
      anesthesia: z.string().nullable(),
    })
    .nullable(),
  preInfo: z
    .object({
      pre: z.string().nullable(),
      induce: z.string().nullable(),
      main: z.string().nullable(),
      post: z.string().nullable(),
    })
    .nullable(),
  comment: z.string().nullable(),
})

type TxFormValues = z.infer<typeof TxFormSchema>

export default function TxchartEditUser({
  txData,
  setaChecklistEditDialogOpen,
}: Props) {
  const [checklistTitles, setCheckListTitles] = useState<string[] | null>()
  const [preChecklistSet, setPreCheckListSet] = useState<ChecklistStateSet>({
    interval: '0',
    preSet: [],
  })
  const [preCheckProtocol, setCheckProtocol] = useState<
    ChecklistProtocol | null | []
  >()
  const [mainProtocol, setMainProtocol] = useState<ProtocolItem>({
    title: null,
    type: 'main',
    addinfo: null,
    dueStart: null,
    mode: null,
  })
  const [subProtocol, setSubProtocol] = useState<ProtocolItem>({
    title: null,
    type: 'sub',
    addinfo: null,
    dueStart: null,
    mode: null,
  })

  useEffect(() => {
    txData && txData.checklist_set && setPreCheckListSet(txData.checklist_set)
    txData && txData.checklist_protocol
      ? setCheckProtocol(txData.checklist_protocol)
      : setCheckProtocol([])
  }, [txData])
  const isEditMode = !!(txData?.checklist_title && txData?.checklist_type)

  const checkingTime = useRef<HTMLInputElement | null>(null)

  const form = useForm<TxFormValues>({
    resolver: zodResolver(TxFormSchema),
    defaultValues: {
      checklistTitle: txData?.checklist_title ?? '',
      checklistVet: {
        attending: txData?.checklist_vet?.attending ?? '',
        primary: txData?.checklist_vet?.primary ?? '',
        assistence: txData?.checklist_vet?.assistence ?? '',
        anesthesia: txData?.checklist_vet?.anesthesia ?? '',
      },
      preInfo: {
        pre: txData?.preinfo?.pre ?? '',
        induce: txData?.preinfo?.induce ?? '',
        main: txData?.preinfo?.main ?? '',
        post: txData?.preinfo?.post ?? '',
      },
      comment: txData?.comment ?? '',
    },
  })
  const onSubmit = async (values: TxFormValues) => {
    const preData = {
      checklist_id: txData?.checklist_id,
      hos_id: txData?.hos_id,
      patient_id: txData?.patient_id,
      checklist_type: 'ÏÇ¨Ïö©Ïûê',
      checklist_vet: txData?.checklist_vet,
      checklist_title: txData?.checklist_title,
      checklist_tag: txData?.checklist_tag,
      checklist_protocol: txData?.checklist_protocol,
      checklist_group: txData?.checklist_group,
      checklist_set: txData?.checklist_set,
      checklist_timetable: txData?.checklist_timetable,
      starttime: txData?.starttime,
      endtime: txData?.endtime,
      comment: txData?.comment,
      preinfo: txData?.preinfo,
      due_date: txData?.due_date,
    } as TxchartData

    // ÏàòÏ†ï Ïã§Ìñâ

    preData.checklist_set = {
      interval: preChecklistSet?.interval,
      preSet:
        preChecklistSet.preSet && preChecklistSet.preSet.length > 0
          ? [...preChecklistSet.preSet]
          : [],
    }
    preData.checklist_protocol = preCheckProtocol ? [...preCheckProtocol] : null
    preData.checklist_vet = values.checklistVet
    preData.preinfo = values.preInfo
    preData.comment = values.comment
    preData.checklist_title = values.checklistTitle

    const supabase = await createClient()
    const { error } = await supabase
      .from('checklist')
      .update(preData)
      .eq('checklist_id', preData.checklist_id)
    if (error) {
      console.error(error)
      redirect(`/error?message=${error.message}`)
    }
    if (!isEditMode) {
      toast({
        title: 'ÏπòÎ£åÏ∞®Ìä∏ Îì±Î°ù ÏôÑÎ£å',
        description: 'ÏπòÎ£åÏ∞®Ìä∏ Îì±Î°ùÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§. Ï∞®Ìä∏Î•º ÏûëÏÑ±ÌïòÏÑ∏Ïöî',
      })
    } else {
      toast({
        title: 'ÏπòÎ£åÏ∞®Ìä∏ ÏàòÏ†ï ÏôÑÎ£å',
        description: 'ÏπòÎ£åÏ∞®Ìä∏ ÏàòÏ†ïÏùÑ ÏôÑÎ£åÌñàÏäµÎãàÎã§.',
      })
    }
    setaChecklistEditDialogOpen(false)
    //   preData.checklist_protocol = preCheckProtocol
    //     ? [...preCheckProtocol]
    //     : null
    //   preData.checklist_vet = values.checklistVet
    //   preData.preinfo = values.preInfo
    //   preData.comment = values.comment

    //   console.log('üõ† ÏàòÏ†ïÌïòÍ∏∞:', preData)
  }

  const addChecklistRow = () => {
    if (checkingTime.current?.value && checklistTitles) {
      const pretime = checkingTime.current ? checkingTime.current.value : '0'
      const prenames = [...checklistTitles]
      const predata = { ...preChecklistSet }
      const presetItem = { settime: String(pretime), setname: [...prenames] }
      const isTime =
        predata &&
        predata.preSet &&
        predata.preSet.find((x) => x.settime === String(pretime))
      if (!isTime) {
        predata.preSet?.push(presetItem)
        setPreCheckListSet(predata)
        checkingTime.current.value = ''
      }
    }
  }

  const changeinterval = (e: React.ChangeEvent<HTMLInputElement>) => {
    const predata = { ...preChecklistSet }
    predata.interval = e.target.value

    setPreCheckListSet(predata)
  }

  const changeProtocolMode = (
    type: string,
    key: keyof ProtocolItem,
    value: string,
  ) => {
    if (type === 'main') {
      const preprotocol = { ...mainProtocol }
      preprotocol[key] = value

      setMainProtocol(preprotocol)
    } else {
      const preprotocol = { ...subProtocol }
      preprotocol[key] = value

      setSubProtocol(preprotocol)
    }
  }
  const addProtocol = (e: React.MouseEvent<HTMLButtonElement>) => {
    const name = e.currentTarget.name
    if (name === 'main' && mainProtocol.title) {
      const premainprotocol = { ...mainProtocol }
      if (premainprotocol.mode && premainprotocol.dueStart) {
        const preData = preCheckProtocol ? [...preCheckProtocol] : []
        preData.push(premainprotocol)
        setCheckProtocol(preData)
        setMainProtocol({
          title: null,
          type: 'main',
          addinfo: null,
          dueStart: null,
          mode: mainProtocol.mode,
        })
      } else {
        premainprotocol.mode = null
        premainprotocol.dueStart = null
        const preData = preCheckProtocol ? [...preCheckProtocol] : []
        preData.push(premainprotocol)
        setCheckProtocol(preData)
        setMainProtocol({
          title: null,
          type: 'main',
          addinfo: null,
          dueStart: null,
          mode: mainProtocol.mode,
        })
      }
    } else if (name === 'sub' && subProtocol.title) {
      const presubprotocol = { ...subProtocol }
      if (presubprotocol.mode && presubprotocol.dueStart) {
        const preData = preCheckProtocol ? [...preCheckProtocol] : []
        preData.push(presubprotocol)
        setCheckProtocol(preData)
        setSubProtocol({
          title: null,
          type: 'sub',
          addinfo: null,
          dueStart: null,
          mode: subProtocol.mode,
        })
      } else {
        presubprotocol.mode = null
        presubprotocol.dueStart = null
        const preData = preCheckProtocol ? [...preCheckProtocol] : []
        preData.push(presubprotocol)
        setCheckProtocol(preData)
        setSubProtocol({
          title: null,
          type: 'sub',
          addinfo: null,
          dueStart: null,
          mode: subProtocol.mode,
        })
      }
    }
  }
  const delProtocol = (e: React.MouseEvent<HTMLButtonElement>) => {
    const preData = preCheckProtocol ? [...preCheckProtocol] : []
    preData.splice(Number(e.currentTarget.name), 1)
    setCheckProtocol(preData)
  }
  const delCheckRow = (e: React.MouseEvent<HTMLButtonElement>) => {
    const preData = { ...preChecklistSet }
    preData &&
      preData.preSet &&
      preData.preSet.splice(Number(e.currentTarget.name), 1)
    setPreCheckListSet(preData)
  }
  return (
    <Form {...form}>
      <form onSubmit={form.handleSubmit(onSubmit)} className="space-y-4">
        <FormField
          control={form.control}
          name="checklistTitle"
          render={({ field }) => (
            <FormItem>
              <FormLabel>1. ÏπòÎ£åÎ™Ö(ÌïÑÏàò)</FormLabel>
              <FormControl>
                <Input
                  {...field}
                  value={field.value ?? ''}
                  placeholder="ÏπòÎ£åÎ™Ö"
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />

        <Accordion
          type="single"
          collapsible
          className="w-full"
          defaultValue={undefined}
        >
          <AccordionItem value="item-1">
            <AccordionTrigger>2. ÏàòÏùòÏÇ¨ ÏÑ§Ï†ï</AccordionTrigger>
            <AccordionContent className="flex flex-col gap-4 text-balance">
              <FormField
                control={form.control}
                name="checklistVet.attending"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Îã¥ÎãπÏùò(Ï£ºÏπòÏùò)</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                        value={field.value ?? ''}
                        placeholder="ÌôòÏûê Îã¥Îãπ ÏàòÏùòÏÇ¨(Ï£ºÏπòÏùò)"
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="checklistVet.primary"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Ïà†Ïûê</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                        value={field.value ?? ''}
                        placeholder="ÏπòÎ£åÎ•º ÏßÑÌñâÌïòÎäî ÏàòÏùòÏÇ¨(ÏÉùÎûµÏãú Îã¥ÎãπÏùòÎ°ú ÏßÄÏ†ï),ex)ÏàòÏùòÏÇ¨1,ÏàòÏùòÏÇ¨2..."
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="checklistVet.assistence"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Î≥¥Ï°∞Ïûê</FormLabel>
                    <FormControl>
                      <Input
                        {...field}
                        value={field.value ?? ''}
                        placeholder="ÏπòÎ£åÎ•º Î≥¥Ï°∞Ïù∏Ïõê(ÏÉùÎûµÍ∞ÄÎä•) ex)ÏàòÏùòÏÇ¨1, Í∞ÑÌò∏ÏÇ¨1..."
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </AccordionContent>
          </AccordionItem>
          <AccordionItem value="item-2">
            <AccordionTrigger>3. Ï≤òÏπòÏ†ïÎ≥¥</AccordionTrigger>
            <AccordionContent className="flex flex-col gap-4 text-balance">
              <FormField
                control={form.control}
                name="preInfo.pre"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Ï†ÑÏ≤òÏπò</FormLabel>
                    <FormControl>
                      <Textarea
                        {...field}
                        value={field.value ?? ''} // null ÎåÄÏùë
                        placeholder="Ï†ÑÏ≤òÏπò ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî(ÏÉùÎûµÍ∞ÄÎä•)"
                        className="min-h-[100px]" // ÌïÑÏöîÌïú Í≤ΩÏö∞ ÎÜíÏù¥ Ï°∞Ï†ï
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="preInfo.main"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>Ï£ºÏöîÏ≤òÏπò</FormLabel>
                    <FormControl>
                      <Textarea
                        {...field}
                        value={field.value ?? ''} // null ÎåÄÏùë
                        placeholder="Ï≤òÏπò Í¥ÄÎ†® ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî(ÏÉùÎûµÍ∞ÄÎä•)"
                        className="min-h-[100px]" // ÌïÑÏöîÌïú Í≤ΩÏö∞ ÎÜíÏù¥ Ï°∞Ï†ï
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
              <FormField
                control={form.control}
                name="preInfo.post"
                render={({ field }) => (
                  <FormItem>
                    <FormLabel>ÌõÑÏ≤òÏπò</FormLabel>
                    <FormControl>
                      <Textarea
                        {...field}
                        value={field.value ?? ''} // null ÎåÄÏùë
                        placeholder="ÌõÑÏ≤òÏπò Í¥ÄÎ†® ÎÇ¥Ïö©ÏùÑ ÏûÖÎ†•Ìï¥Ï£ºÏÑ∏Ïöî(ÏÉùÎûµÍ∞ÄÎä•)"
                        className="min-h-[100px]" // ÌïÑÏöîÌïú Í≤ΩÏö∞ ÎÜíÏù¥ Ï°∞Ï†ï
                      />
                    </FormControl>
                    <FormMessage />
                  </FormItem>
                )}
              />
            </AccordionContent>
          </AccordionItem>
          <AccordionItem value="item-3">
            <AccordionTrigger>4. Ï≤¥ÌÅ¨Î¶¨Ïä§Ìä∏ ÏÑ§Ï†ï</AccordionTrigger>
            <AccordionContent className="flex flex-col gap-4 text-balance">
              <div className="flex flex-wrap items-center">
                <div className="ml-3 mr-2 text-sm">Í∏∞Î≥∏ Ï∏°Ï†ïÍ∞ÑÍ≤©</div>

                <Input
                  value={
                    preChecklistSet && preChecklistSet.interval
                      ? preChecklistSet.interval
                      : ''
                  }
                  onChange={changeinterval}
                  placeholder="min"
                  className="w-15"
                />
              </div>
              <div className="flex flex-wrap items-center justify-start gap-2 px-3">
                <div className="mr-2 text-sm">Ï∏°Ï†ïÌï≠Î™©</div>
                <ToggleGroup
                  onValueChange={(value) => {
                    if (value) {
                      setCheckListTitles(value)
                    }
                  }}
                  type="multiple"
                  variant="outline"
                  size="sm"
                >
                  {checkListSetArray.map((check, i) => (
                    <ToggleGroupItem
                      key={check.name}
                      value={check.name}
                      aria-label="Toggle bold"
                    >
                      <div className="minw-4 h-4">{check.displayName}</div>
                    </ToggleGroupItem>
                  ))}
                </ToggleGroup>
                <div className="mr-2 text-sm">Ï∏°Ï†ïÏãúÍ∞Ñ</div>
                <Input placeholder="min" ref={checkingTime} className="w-13" />

                <Button type="button" onClick={addChecklistRow}>
                  Ï∂îÍ∞Ä
                </Button>
              </div>
              {preChecklistSet &&
                preChecklistSet.preSet &&
                preChecklistSet.preSet.length > 0 && (
                  <Table className="bg-gray-100">
                    <TableHeader>
                      <TableRow>
                        <TableHead className="w-[200px]">
                          ÏãúÏûëÌõÑ Ï∏°Ï†ïÏãúÍ∞Ñ(Î∂Ñ)
                        </TableHead>
                        <TableHead>Ï∏°Ï†ïÌï≠Î™©</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {preChecklistSet.preSet.map((set, i) => (
                        <TableRow key={set.settime}>
                          <TableCell>{set.settime}</TableCell>
                          <TableCell>
                            <div>
                              {' '}
                              {set.setname?.map((name) => name + ' ')}
                              <Button
                                type="button"
                                name={String(i)}
                                onClick={delCheckRow}
                                variant="outline"
                                size="sm"
                              >
                                X
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                )}
            </AccordionContent>
          </AccordionItem>

          <AccordionItem value="item-4">
            <AccordionTrigger>5. ÏπòÎ£åÍ≥ºÏ†ï ÏÑ§Ï†ï</AccordionTrigger>
            <AccordionContent className="flex flex-col gap-4 text-balance">
              {/* minaprotocol */}

              <div className="flex flex-wrap items-center">
                <div className="ml-3 mr-2 text-sm">Ï£ºÏöîÍ≥ºÏ†ï Ï∂îÍ∞Ä</div>
                <Input
                  value={
                    mainProtocol && mainProtocol.title ? mainProtocol.title : ''
                  }
                  placeholder="Ï£ºÏöîÍ≥ºÏ†ï Ï∂îÍ∞Ä"
                  className="w-[300px]"
                  onChange={(e) => {
                    changeProtocolMode('main', 'title', e.target.value)
                  }}
                />
                <div className="ml-2 mr-2 text-sm">:</div>
                <Select
                  defaultValue={
                    mainProtocol && mainProtocol.mode ? mainProtocol.mode : ''
                  }
                  onValueChange={(value) => {
                    changeProtocolMode('main', 'mode', value)
                  }}
                >
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="ÏãúÍ∞ÑÏ∏°Ï†ï ÏãúÏ†ê ÏÑ§Ï†ï" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="afterStart">ÏπòÎ£åÏãúÏûëÌõÑ</SelectItem>
                    <SelectItem value="afterMain">Î©îÏù∏Í≥ºÏ†ï ÏãúÏûë ÌõÑ</SelectItem>
                    <SelectItem value="afterSub">ÏßÅÏ†ÑÍ≥ºÏ†ï ÏôÑÎ£å ÌõÑ</SelectItem>
                  </SelectContent>
                </Select>

                <Input
                  placeholder="min"
                  type="number"
                  className="mr-2 w-[100px]"
                  value={
                    mainProtocol && mainProtocol.dueStart
                      ? mainProtocol.dueStart
                      : ''
                  }
                  onChange={(e) => {
                    changeProtocolMode('main', 'dueStart', e.target.value)
                  }}
                />
                <div className="ml-2 mr-2 text-sm">Î∂ÑÌõÑÏãúÏûë</div>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button type="button" variant="outline" className="mr-2">
                      Ï∂îÍ∞ÄÏ†ïÎ≥¥
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent>
                    <Textarea
                      value={
                        mainProtocol && mainProtocol.addinfo
                          ? mainProtocol.addinfo
                          : ''
                      }
                      onChange={(e) => {
                        changeProtocolMode('main', 'addinfo', e.target.value)
                      }}
                    ></Textarea>
                  </PopoverContent>
                </Popover>
                <div>
                  <Button type="button" name="main" onClick={addProtocol}>
                    Ï∂îÍ∞Ä
                  </Button>
                </div>
              </div>

              {/* subprotocol */}

              <div className="flex flex-wrap items-center">
                <div className="ml-3 mr-2 text-sm">ÏÑ∏Î∂ÄÍ≥ºÏ†ï Ï∂îÍ∞Ä</div>
                <Input
                  value={
                    subProtocol && subProtocol.title ? subProtocol.title : ''
                  }
                  placeholder="Ï£ºÏöîÍ≥ºÏ†ï Ï∂îÍ∞Ä"
                  className="w-[300px]"
                  onChange={(e) => {
                    changeProtocolMode('sub', 'title', e.target.value)
                  }}
                />
                <div className="ml-2 mr-2 text-sm">:</div>
                <Select
                  defaultValue={
                    subProtocol && subProtocol.mode ? subProtocol.mode : ''
                  }
                  onValueChange={(value) => {
                    changeProtocolMode('main', 'mode', value)
                  }}
                >
                  <SelectTrigger className="w-[180px]">
                    <SelectValue placeholder="ÏãúÍ∞ÑÏ∏°Ï†ï ÏãúÏ†ê ÏÑ§Ï†ï" />
                  </SelectTrigger>
                  <SelectContent>
                    <SelectItem value="afterStart">ÏπòÎ£åÏãúÏûëÌõÑ</SelectItem>
                    <SelectItem value="afterMain">Î©îÏù∏Í≥ºÏ†ï ÏãúÏûë ÌõÑ</SelectItem>
                    <SelectItem value="afterSub">ÏßÅÏ†ÑÍ≥ºÏ†ï ÏôÑÎ£å ÌõÑ</SelectItem>
                  </SelectContent>
                </Select>

                <Input
                  placeholder="min"
                  type="number"
                  className="mr-2 w-[100px]"
                  value={
                    subProtocol && subProtocol.dueStart
                      ? subProtocol.dueStart
                      : ''
                  }
                  onChange={(e) => {
                    changeProtocolMode('main', 'dueStart', e.target.value)
                  }}
                />
                <div className="ml-2 mr-2 text-sm">Î∂ÑÌõÑÏãúÏûë</div>
                <Popover>
                  <PopoverTrigger asChild>
                    <Button type="button" variant="outline">
                      Ï∂îÍ∞ÄÏ†ïÎ≥¥
                    </Button>
                  </PopoverTrigger>
                  <PopoverContent>
                    <Textarea
                      value={
                        subProtocol && subProtocol.addinfo
                          ? subProtocol.addinfo
                          : ''
                      }
                      onChange={(e) => {
                        changeProtocolMode('sub', 'addinfo', e.target.value)
                      }}
                    ></Textarea>
                  </PopoverContent>
                </Popover>
                <div>
                  <Button type="button" name="sub" onClick={addProtocol}>
                    Ï∂îÍ∞Ä
                  </Button>
                </div>
              </div>
              <div>
                {preCheckProtocol && preCheckProtocol.length > 0 && (
                  <Table>
                    <TableHeader>
                      <TableRow>
                        <TableHead>Í≥ºÏ†ï</TableHead>
                        <TableHead>Ïã§ÌñâÏãúÏ†ê</TableHead>

                        <TableHead>Ï∂îÍ∞ÄÏ†ïÎ≥¥</TableHead>
                      </TableRow>
                    </TableHeader>
                    <TableBody>
                      {preCheckProtocol.map((protocol, i) => (
                        <TableRow key={protocol.title + '-' + i}>
                          <TableCell>
                            {protocol.type === 'main' ? (
                              <div className="font-bold">
                                {protocol.title}(Ï£ºÏöîÍ≥ºÏ†ï)
                              </div>
                            ) : (
                              <div className="ml-10">
                                {protocol.title}(ÏÑ∏Î∂ÄÍ≥ºÏ†ï)
                              </div>
                            )}
                          </TableCell>
                          <TableCell>
                            {protocol.mode === 'afterMain'
                              ? 'Ï£ºÏöîÍ≥ºÏ†ï ÏãúÏûë '
                              : protocol.mode === 'afterStart'
                                ? 'ÏπòÎ£å ÏãúÏûë '
                                : protocol.mode === 'afterSub'
                                  ? 'Ïù¥Ï†ÑÍ≥ºÏ†ï Ïã§Ìñâ '
                                  : ''}
                            {protocol.dueStart
                              ? protocol.dueStart + 'Î∂ÑÌõÑ'
                              : ''}
                          </TableCell>
                          {/* <TableCell>
                            {protocol.dueStart ?? ''}
                            {protocol.dueStart ? 'Î∂ÑÌõÑ' : ''}
                          </TableCell> */}
                          <TableCell>
                            {protocol.addinfo ? (
                              <Popover>
                                <PopoverTrigger>
                                  <div>Ï∂îÍ∞ÄÏ†ïÎ≥¥</div>
                                </PopoverTrigger>
                                <PopoverContent>
                                  <div className="whitespace-pre-wrap">
                                    {protocol.addinfo}
                                  </div>
                                </PopoverContent>
                              </Popover>
                            ) : (
                              ''
                            )}
                            <div>
                              <Button
                                type="button"
                                name={String(i)}
                                onClick={delProtocol}
                                variant="outline"
                              >
                                X
                              </Button>
                            </div>
                          </TableCell>
                        </TableRow>
                      ))}
                    </TableBody>
                  </Table>
                )}
              </div>
            </AccordionContent>
          </AccordionItem>
        </Accordion>
        <FormField
          control={form.control}
          name="comment"
          render={({ field }) => (
            <FormItem>
              <FormLabel>Ï¢ÖÌï©ÏÜåÍ≤¨</FormLabel>
              <FormControl>
                <Textarea
                  {...field}
                  value={field.value ?? ''} // null ÎåÄÏùë
                  placeholder="ÏπòÎ£åÍ¥ÄÎ†® Ï¢ÖÌï© ÏÜåÍ≤¨ ÏûëÏÑ±"
                  className="min-h-[100px]" // ÌïÑÏöîÌïú Í≤ΩÏö∞ ÎÜíÏù¥ Ï°∞Ï†ï
                />
              </FormControl>
              <FormMessage />
            </FormItem>
          )}
        />
        {/* Î≤ÑÌäº */}

        <div>
          <Button type="submit">{isEditMode ? 'ÏàòÏ†ï' : 'Îì±Î°ù'}</Button>
          {form.formState.errors.checklistTitle && (
            <div className="text-red-500">
              {form.formState.errors.checklistTitle.message}
            </div>
          )}
        </div>
      </form>
    </Form>
  )
}
